define("qtype_formulas/editing",["exports","core/notification"],(function(_exports,_notification){
/**
   * Javascript function for the editing interface of formulas question type
   *
   * @copyright &copy; 2010-2011 Hon Wai, Lau
   * @author Hon Wai, Lau <lau65536@gmail.com>
   * @license http://www.gnu.org/copyleft/gpl.html GNU Public License version 3
   */
function formulasFormCorrectness(id,checked){var errNames=new Array(M.util.get_string("relerror","qtype_formulas"),M.util.get_string("abserror","qtype_formulas")),nid="correctness["+id+"]",n=document.getElementsByName(nid)[0];if(null!==n){var bid="id_correctness_"+id+"_buttons",b=document.getElementById(bid);if(null===b){var tmp=document.createElement("div");tmp.id=bid,b=n.parentNode.appendChild(tmp)}var useRawInput=checked;if(!useRawInput){var res=/^\s*(_relerr|_err)\s*(<|==)\s*([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)\s*$/.exec(n.value);if(null===res&&0==n.value.replace(/^\s+|\s+$/g,"").length&&(res=["","_relerr","<","0.01"],n.value="_relerr < 0.01"),null===res)useRawInput=!0;else{var s='<select id="'.concat(bid,'_type" class="mform form-inline form-control">');"_relerr"===res[1]?(s+='<option value="_relerr" selected="selected">'.concat(errNames[0],"</option>"),s+='<option value="_err">'.concat(errNames[1],"</option>")):(res[1],s+='<option value="_relerr">'.concat(errNames[0],"</option>"),s+='<option value="_err" selected="selected">'.concat(errNames[1],"</option>")),s+="</select>",s+='<select id="'.concat(bid,'_op" class="mform form-inline form-control">'),"<"===res[2]?(s+='<option value="<" selected="selected">&lt</option>',s+='<option value="==">==</option>'):"=="===res[2]?(s+='<option value="<">&lt</option>',s+='<option value="==" selected="selected">==</option>'):(s+='<option value="<">&lt</option>',s+='<option value="==">==</option>'),s+="</select>",s+='<input id="'.concat(bid,'_tol" type="text" class="mform form-inline form-control" value="').concat(res[3],'">'),b.innerHTML=s,b.addEventListener("change",(e=>{const select=e.target.closest("select");if(select.id==="".concat(bid,"_type"))return void this.formMerge(id);if(select.id==="".concat(bid,"_op"))return void this.formMerge(id);e.target.closest("input").id!=="".concat(bid,"_tol")||this.formMerge(id)}))}}n.style.display=useRawInput?"block":"none",b.style.display=useRawInput?"none":"block"}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0;class FormulasForm{constructor(){this.numsubq=this.countParts();try{this.initialiseGlobalOptionsForNamedItem("unitpenalty"),this.initialiseGlobalOptionsForNamedItem("ruleid")}catch(e){window.console.warning(e)}for(let i=0;i<this.numsubq;i++)try{this.initialiseSelectiveCriteria(i)}catch(e){(0,_notification.exception)(e)}try{this.initialiseNumdatasetOption(),this.showDatasetAndPreview("none")}catch(e){window.console.warning(e)}}formMerge(id){const correctnessElement=document.querySelector('[name="correctness['.concat(id,']"]')),bid="id_correctness_".concat(id,"_buttons"),errorType=document.getElementById("".concat(bid,"_type")).value,errorOp=document.getElementById("".concat(bid,"_op")).value,errorVal=document.getElementById("".concat(bid,"_tol")).value;correctnessElement.value="".concat(errorType," ").concat(errorOp," ").concat(errorVal)}updateOptionsFromGlobal(name){const globalNamedOption=document.getElementsByName("global".concat(name))[0];[...document.querySelectorAll('[name^="'.concat(name,"["))].forEach((element=>{element.value=globalNamedOption.value,element.closest(".form-group").classList.add("hide")}))}countParts(){return document.querySelectorAll('[name^="answermark["]').length-1}initialiseGlobalOptionsForNamedItem(name){const globalNamedOption=document.querySelector('[name="global'.concat(name,'"]')),firstNamedOption=document.querySelector('[name="'.concat(name,'[0]"]'));globalNamedOption.value=firstNamedOption.value,globalNamedOption.addEventListener("change",(()=>{this.updateOptionsFromGlobal(name)})),this.updateOptionsFromGlobal(name)}initialiseSelectiveCriteria(i){const loc=document.getElementById("id_correctness_".concat(i)).parentNode.closest(":not(.fitem)"),showId="id_correctness_".concat(i,"_show");let showCorrectnessField=document.getElementById(showId);if(null===showCorrectnessField){var tmp=document.createElement("div");tmp.id=showId,tmp.classList.add("formulas_correctness_show"),showCorrectnessField=loc.insertBefore(tmp,loc.firstChild)}formulasFormCorrectness(i,!1);const wrapper=document.createElement("span");wrapper.append(...showCorrectnessField.children),showCorrectnessField.append(wrapper);const checkbox=document.createElement("input");checkbox.id=showId,checkbox.checked=!0,checkbox.value="Expert",showCorrectnessField.prepend(checkbox),showCorrectnessField.addEventListener("click",(()=>{formulasFormCorrectness(i,checkbox.checked)}))}initialiseNumdatasetOption(){const options=Object.entries((_ref=>{let[key,value]=_ref;const selected=5==key?'selected="selected"':"",option=document.createElement("option");return option.value=key,option.innerHTML=value,5==selected&&(option.selected=!0),option})),select=document.createElement("select");select.append(...options),select.name="numdataset",select.id="numdataset";const button=document.createElement("input");button.type="button",button.value=M.util.get_string("instantiate","qtype_formulas"),button.addEventListener("click",(()=>{this.instantiateDataset()}));const div=document.createElement("div");div.id="xxx";document.getElementById("numdataset_option").append(select,button,div)}instantiateDataset(){var data=[];data.varsrandom=document.getElementById("id_varsrandom").value,data.varsglobal=document.getElementById("id_varsglobal").value;for(var i=0;i<this.numsubq;i++)data["varslocals["+i+"]"]=document.getElementById("id_vars1_"+i).value,data["answers["+i+"]"]=document.getElementById("id_answer_"+i).value;data.start=0,data.N=document.getElementById("numdataset").value,data.random=0;var p=[];for(var key in data)p[p.length]=encodeURIComponent(key)+"="+encodeURIComponent(data[key]);let params=p.join("&").replace(/ /g,"+");var url=M.cfg.wwwroot+"/question/type/formulas/instantiate.php",request=new XMLHttpRequest;request.open("POST",url,!0),request.setRequestHeader("Content-type","application/x-www-form-urlencoded"),request.setRequestHeader("Content-length",params.length),request.setRequestHeader("Connection","close"),request.addEventListener("readystatechange",(()=>{if(4==request.readyState&&200==request.status){this.vars=JSON.parse(request.responseText),this.showDatasetAndPreview("block");try{this.updateDataset()}catch(e){window.console.error(e)}try{this.updateStatistics()}catch(e){window.console.error(e)}try{this.initPreviewControls()}catch(e){window.console.error(e)}}})),request.send(params),this.showDatasetAndPreview("hidden")}showDatasetAndPreview(show){["qtextpreview_display","varsstatistics_display","varsdata_display"].forEach((id=>{document.getElementById(id).closest(".felement").classList.toggle("hide","hidden"==show)}))}getGroupnames(){const groupnames=["leading","random","global"];for(let i=0;i<100;i++)groupnames.push("local".concat(i),"answer".concat(i));return groupnames}updateDataset(){const loc=document.getElementById("varsdata_display");loc.innerHTML="";const groupnames=this.getGroupnames(),names=Object.assign({},this.vars.names);names.leading=["#"];const lists=this.vars.lists.map((listItem=>Object.assign({},listItem))),finalItem=lists.length-1;lists[finalItem].leading=[finalItem];const result=this.getDatasetDisplay(names,lists,this.vars.errors,groupnames);loc.innerHTML=result}updateStatistics(){var loc=document.getElementById("varsstatistics_display");loc.innerHTML="";var groupnames=this.getGroupnames(),quantities=["min","max"],errors=[],names={leading:[""]};for(let z in this.vars.names)names[z]=this.vars.names[z];var lists=[];for(let k=0;k<quantities.length;k++)lists.push({});for(let i=0;i<groupnames.length;i++){var n=this.vars.names[groupnames[i]];if(null!==n){for(var stat=[],j=0;j<n.length;j++){for(var data=[],count=0;count<this.vars.lists.length;count++)try{var subset=this.vars.lists[count][groupnames[i]];data.push(subset[j])}catch(e){window.console.error(e)}var tmpst=this.getStatistics(data);stat.push(tmpst)}for(let k=0;k<quantities.length;k++){lists[k][groupnames[i]]=[];for(var z=0;z<stat.length;z++)lists[k][groupnames[i]][z]=stat[z][quantities[k]]}}}for(let k=0;k<quantities.length;k++)lists[k].leading=[quantities[k]],errors[k]="";var result=this.getDatasetDisplay(names,lists,errors,groupnames);loc.innerHTML=result}getStatistics(data){for(var sum=0,sum2=0,minimum=Number.MAX_VALUE,maximum=-Number.MAX_VALUE,N=0,i=0;i<data.length;i++)isNaN(data[i])||(sum+=data[i],sum2+=data[i]*data[i],minimum=Math.min(minimum,data[i]),maximum=Math.max(maximum,data[i]),N++);if(0==N)return{};var sd=Math.sqrt((sum2-sum*sum/N)/(N-1));return(N<=1||isNaN(sd))&&(sd=0),{N:N,mean:sum/N,SD:sd,min:minimum,max:maximum}}getDatasetDisplayHeader(names,groupNames){return groupNames.map((groupName=>null===names[groupName]?null:names[groupName].map((name=>"<th>".concat(name,"</th>"))).join("\n"))).filter((value=>!!value)).join("\n")}getDatasetDisplay(names,lists,errors,groupnames){let header=this.getDatasetDisplayHeader(names,groupnames);header+="<tr>"+header+"</tr>";let s="";for(let count=0;count<lists.length;count++){count%50==0&&(s+=header);let row="";for(let i=0;i<groupnames.length;i++){const n=names[groupnames[i]];if(null===n)continue;const subset=lists[count][groupnames[i]];if(null===subset||subset.length!=n.length)break;for(let j=0;j<n.length;j++)try{row+="<td>"+this.getDatasetShorten(subset[j])+"</td>"}catch(e){row+="<td></td>"}}s+='<tr class="r'.concat(count%2,'">').concat(row),""!==errors[count]&&(s+="<td>".concat(errors[count],"</td>")),s+="</tr>"}return'<table border="1" width="100%" cellpadding="3">'.concat(s,"</table>")}getDatasetShorten(elem){if(elem instanceof Array){for(var tmpSs=[],k=0;k<elem.length;k++)if("string"==typeof elem[k])tmpSs[k]=elem[k];else{var s=elem[k].toPrecision(4).length<(""+elem[k]).length?elem[k].toPrecision(4):""+elem[k];tmpSs[k]='<span title="'+elem[k]+'">'+s+"</span>"}return tmpSs.join(", ")}if("string"==typeof elem)return'<span title="'+elem+'">'+elem+"</span>";{const s=elem.toPrecision(4).length<(""+elem).length?elem.toPrecision(4):""+elem;return'<span title="'+elem+'">'+s+"</span>"}}initPreviewControls(){const loc=document.getElementById("qtextpreview_controls");loc.innerHTML="";const options=this.vars.list.map((listItem=>{const option=document.createElement("option");return option.value=listItem,option.innerHTML=listItem,option}));if(options.length){const select=document.createElement("select");select.id="id_formulas_idataset",select.append(...options),loc.append(select)}const button=document.createElement("button");button.value=M.util.get_string("renew","qtype_formulas"),loc.append(button),loc.addEventListener("click",(()=>{this.updatePreview()})),this.updatePreview()}updatePreview(){let globaltext;try{globaltext=window.tinyMCE.get("id_questiontext").getContent()}catch(e){globaltext=document.getElementById("id_questiontext").value}for(var idataset=document.getElementById("id_formulas_idataset").value,res=this.substituteVariablesInText(globaltext,this.getVariablesMapping(idataset,["random","global"])),i=0;i<this.numsubq;i++){let txt,fb;try{txt=window.tinyMCE.get("id_subqtext_"+i).getContent()}catch(e){txt=document.getElementById("id_subqtext_"+i).value}try{fb=window.tinyMCE.get("id_feeback_"+i).getContent()}catch(e){fb=document.getElementById("id_feedback_"+i).value}var ph=document.getElementsByName("placeholder["+i+"]")[0],unit=document.getElementsByName("postunit["+i+"]")[0],answer=this.getVariablesMapping(idataset,["answer"+i])["@"+(i+1)];if(null!==answer){var mapping=this.getVariablesMapping(idataset,["random","global","local"+i]),t=txt+'<div style="border: solid 1px #aaaaaa; margin : 10px">'.concat(answer," ").concat(unit.value.split("=")[0],"</div>");t+=fb.length>0?'<div style="border: solid 1px #aaaaaa; margin : 10px">'+fb+"</div>":"",t='<div style="border: solid 1px #ddddff;"> '+(t=this.substituteVariablesInText(t,mapping))+"</div>",""==ph.value?res+=t:res=res.replace("{"+ph.value+"}",t)}}document.getElementById("qtextpreview_display").innerHTML='<div style="border: solid black 2px; padding : 5px">'+res+"</div>"}getVariablesMapping(idataset,groupnames){const mapping={};for(var i=0;i<groupnames.length;i++){var names=this.vars.names[groupnames[i]];if(null!==names){var subset=this.vars.lists[idataset][groupnames[i]];if(null===subset||subset.length!=names.length)break;for(var j=0;j<names.length;j++)mapping[names[j]]=subset[j]}}return mapping}substituteVariablesInText(text,mapping){var matches=text.match(/\{([A-Za-z][A-Za-z0-9_]*)(\[([0-9]+)\])?\}/g);if(null===matches||0==matches.length)return text;for(var i=0;i<matches.length;i++){var d=/\{([A-Za-z][A-Za-z0-9_]*)(\[([0-9]+)\])?\}/.exec(matches[i]);if(null===d)continue;if(null===mapping[d[1]])continue;let value=mapping[d[1]];if(value instanceof Array){var idx=parseInt(d[3]);if(idx>=value.length)continue;value=value[idx]}text=text.replace(matches[i],value)}return text}}_exports.init=()=>new FormulasForm}));

//# sourceMappingURL=editing.min.js.map